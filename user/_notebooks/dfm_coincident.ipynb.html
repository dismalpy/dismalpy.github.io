

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Dynamic factors and coincident indices &mdash; DismalPy 0.1.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="author" title="About these documents"
              href="../../about.html"/>
    <link rel="top" title="DismalPy 0.1.0 documentation" href="../../index.html"/>
        <link rel="up" title="State Space Models" href="../ssm.html"/>
        <link rel="next" title="VARMAX models" href="varmax.ipynb.html"/>
        <link rel="prev" title="Detrending, Stylized Facts and the Business Cycle" href="structural_harvey_jaeger.ipynb.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="../../contents.html" class="icon icon-home"> DismalPy
        

        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">DismalPy User Guide</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../ssm.html">State Space Models</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../ssm.html#topics">Topics</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../ssm/2-state_space_models.html">State space models</a></li>
<li class="toctree-l4"><a class="reference internal" href="../ssm/3-python_representation.html">Representation in Python</a></li>
<li class="toctree-l4"><a class="reference internal" href="../ssm/4-maximum_likelihood_estimation.html">Maximum Likelihood Estimation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../ssm/5-posterior_simulation.html">Posterior Simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../ssm/6-out-of-the-box_models.html">Out-of-the-box models</a></li>
<li class="toctree-l4"><a class="reference internal" href="../ssm/9-references.html">References</a></li>
</ul>
</li>
<li class="toctree-l3 current"><a class="reference internal" href="../ssm.html#examples">Examples</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="sarimax_internet.ipynb.html">Durbin and Koopman: Box-Jenkins Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="sarimax_stata.ipynb.html">SARIMAX: Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="local_linear_trend.ipynb.html">State space modeling: Local Linear Trends</a></li>
<li class="toctree-l4"><a class="reference internal" href="structural_harvey_jaeger.ipynb.html">Detrending, Stylized Facts and the Business Cycle</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="">Dynamic factors and coincident indices</a></li>
<li class="toctree-l4"><a class="reference internal" href="varmax.ipynb.html">VARMAX models</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">DismalPy Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../reference/ssm.html">State Space Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/ssm.html#built-in-models">Built-in models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/ssm/sarimax.html">SARIMAX</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/ssm/structural.html">Unobserved Components</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/ssm/varmax.html">VARMAX</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/ssm/dynamic_factor.html">Dynamic Factors</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/ssm.html#extension-starting-point">Extension starting point</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/ssm/mlemodel.html">MLEModel</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/ssm.html#base-classes">Base classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/ssm/representation.html">Representation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/ssm/kalman_filter.html">Kalman filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/ssm/kalman_smoother.html">Kalman smoother</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/ssm/simulation_smoother.html">Simulation Smoother</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/ssm/model.html">Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/ssm/tools.html">Tools</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../release.html">Release Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../release.html#dismalpy-0-1-0-release-notes">DismalPy 0.1.0 Release Notes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../release.html#highlights">Highlights</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../release.html#dropped-support">Dropped Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../release.html#future-changes">Future Changes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../release.html#compatibility-notes">Compatibility notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../release.html#new-features">New Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../release.html#improvements">Improvements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../release.html#changes">Changes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../release.html#deprecations">Deprecations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About DismalPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html#about-this-documentation">About this documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../about.html#conventions">Conventions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../bugs.html">Reporting bugs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">DismalPy License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../glossary.html#module-dismalpy.doc.jargon">Jargon</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../contents.html">DismalPy</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../contents.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">DismalPy User Guide</a> &raquo;</li>
      
          <li><a href="../ssm.html">State Space Models</a> &raquo;</li>
      
    <li>Dynamic factors and coincident indices</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/user/_notebooks/dfm_coincident.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="dynamic-factors-and-coincident-indices">
<h1>Dynamic factors and coincident indices<a class="headerlink" href="#dynamic-factors-and-coincident-indices" title="Permalink to this headline">Â¶</a></h1>
<p>Factor models generally try to find a small number of unobserved
&#8220;factors&#8221; that influence a subtantial portion of the variation in a
larger number of observed variables, and they are related to
dimension-reduction techniques such as principal components analysis.
Dynamic factor models explicitly model the transition dynamics of the
unobserved factors, and so are often applied to time-series data.</p>
<p>Macroeconomic coincident indices are designed to capture the common
component of the &#8220;business cycle&#8221;; such a component is assumed to
simultaneously affect many macroeconomic variables. Although the
estimation and use of coincident indices (for example the <a class="reference external" href="http://www.newyorkfed.org/research/regional_economy/coincident_summary.html">Index of
Coincident Economic
Indicators</a>)
pre-dates dynamic factor models, in several influential papers Stock and
Watson (1989, 1991) used a dynamic factor model to provide a theoretical
foundation for them.</p>
<p>Below, we follow the treatment found in Kim and Nelson (1999), of the
Stock and Watson (1991) model, to formulate a dynamic factor model,
estimate its parameters via maximum likelihood, and create a coincident
index.</p>
<div class="section" id="macroeconomic-data">
<h2>Macroeconomic data<a class="headerlink" href="#macroeconomic-data" title="Permalink to this headline">Â¶</a></h2>
<p>The coincident index is created by considering the comovements in four
macroeconomic variables (versions of thse variables are available on
<a class="reference external" href="https://research.stlouisfed.org/fred2/">FRED</a>; the ID of the series
used below is given in parentheses):</p>
<ul class="simple">
<li>Industrial production (IPMAN)</li>
<li>Real aggregate income (excluding transfer payments) (W875RX1)</li>
<li>Manufacturing and trade sales (CMRMTSPL)</li>
<li>Employees on non-farm payrolls (PAYEMS)</li>
</ul>
<p>In all cases, the data is at the monthly frequency and has been
seasonally adjusted; the time-frame considered is 1972 - 2005.</p>
<div class="code python highlight-python"><div class="highlight"><pre>%matplotlib inline

import numpy as np
import pandas as pd
import statsmodels.api as sm
import dismalpy as dp
import matplotlib.pyplot as plt

np.set_printoptions(precision=4, suppress=True, linewidth=120)
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pandas.io.data</span> <span class="kn">import</span> <span class="n">DataReader</span>

<span class="c"># Get the datasets from FRED</span>
<span class="n">start</span> <span class="o">=</span> <span class="s">&#39;1979-01-01&#39;</span>
<span class="n">end</span> <span class="o">=</span> <span class="s">&#39;2014-12-01&#39;</span>
<span class="n">indprod</span> <span class="o">=</span> <span class="n">DataReader</span><span class="p">(</span><span class="s">&#39;IPMAN&#39;</span><span class="p">,</span> <span class="s">&#39;fred&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
<span class="n">income</span> <span class="o">=</span> <span class="n">DataReader</span><span class="p">(</span><span class="s">&#39;W875RX1&#39;</span><span class="p">,</span> <span class="s">&#39;fred&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
<span class="c"># sales = DataReader(&#39;CMRMTSPL&#39;, &#39;fred&#39;, start=start, end=end)</span>
<span class="n">emp</span> <span class="o">=</span> <span class="n">DataReader</span><span class="p">(</span><span class="s">&#39;PAYEMS&#39;</span><span class="p">,</span> <span class="s">&#39;fred&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
<span class="c"># dta = pd.concat((indprod, income, sales, emp), axis=1)</span>
<span class="c"># dta.columns = [&#39;indprod&#39;, &#39;income&#39;, &#39;sales&#39;, &#39;emp&#39;]</span>
</pre></div>
</div>
<p><strong>Note</strong>: in the most recent update on FRED (8/12/15) the time series
CMRMTSPL was truncated to begin in 1997; this is probably a mistake due
to the fact that CMRMTSPL is a spliced series, so the earlier period is
from the series HMRMT and the latter period is defined by CMRMT.</p>
<p>Until this is corrected, the pre-8/12/15 dataset can be downloaded from
Alfred (<a class="reference external" href="https://alfred.stlouisfed.org/series/downloaddata?seid=CMRMTSPL">https://alfred.stlouisfed.org/series/downloaddata?seid=CMRMTSPL</a>)
or constructed by hand from HMRMT and CMRMT, as I do below (process
taken from the notes in the Alfred xls file).</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">HMRMT</span> <span class="o">=</span> <span class="n">DataReader</span><span class="p">(</span><span class="s">&#39;HMRMT&#39;</span><span class="p">,</span> <span class="s">&#39;fred&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s">&#39;1967-01-01&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
<span class="n">CMRMT</span> <span class="o">=</span> <span class="n">DataReader</span><span class="p">(</span><span class="s">&#39;CMRMT&#39;</span><span class="p">,</span> <span class="s">&#39;fred&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s">&#39;1997-01-01&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">HMRMT_growth</span> <span class="o">=</span> <span class="n">HMRMT</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span> <span class="o">/</span> <span class="n">HMRMT</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span>
<span class="n">sales</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">emp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">index</span><span class="o">=</span><span class="n">emp</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="c"># Fill in the recent entries (1997 onwards)</span>
<span class="n">sales</span><span class="p">[</span><span class="n">CMRMT</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMRMT</span>

<span class="c"># Backfill the previous entries (pre 1997)</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">sales</span><span class="o">.</span><span class="n">ix</span><span class="p">[:</span><span class="s">&#39;1997-01-01&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">month</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
    <span class="n">prev_month</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sales</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">prev_month</span><span class="p">]</span> <span class="o">=</span> <span class="n">sales</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">HMRMT_growth</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">prev_month</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">dta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">indprod</span><span class="p">,</span> <span class="n">income</span><span class="p">,</span> <span class="n">sales</span><span class="p">,</span> <span class="n">emp</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dta</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;indprod&#39;</span><span class="p">,</span> <span class="s">&#39;income&#39;</span><span class="p">,</span> <span class="s">&#39;sales&#39;</span><span class="p">,</span> <span class="s">&#39;emp&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">dta</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="s">&#39;indprod&#39;</span><span class="p">:</span><span class="s">&#39;emp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subplots</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">));</span>
</pre></div>
</div>
<img alt="../../_images/dfm_coincident.ipynb_8_0.png" src="../../_images/dfm_coincident.ipynb_8_0.png" />
<p>Stock and Watson (1991) report that for their datasets, they could not
reject the null hypothesis of a unit root in each series (so the series
are integrated), but they did not find strong evidence that the series
were co-integrated.</p>
<p>As a result, they suggest estimating the model using the first
differences (of the logs) of the variables, demeaned and standardized.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Create log-differenced series</span>
<span class="n">dta</span><span class="p">[</span><span class="s">&#39;dln_indprod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dta</span><span class="o">.</span><span class="n">indprod</span><span class="p">))</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">dta</span><span class="p">[</span><span class="s">&#39;dln_income&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dta</span><span class="o">.</span><span class="n">income</span><span class="p">))</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">dta</span><span class="p">[</span><span class="s">&#39;dln_sales&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dta</span><span class="o">.</span><span class="n">sales</span><span class="p">))</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">dta</span><span class="p">[</span><span class="s">&#39;dln_emp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dta</span><span class="o">.</span><span class="n">emp</span><span class="p">))</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>

<span class="c"># De-mean and standardize</span>
<span class="n">dta</span><span class="p">[</span><span class="s">&#39;std_indprod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dta</span><span class="p">[</span><span class="s">&#39;dln_indprod&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dta</span><span class="p">[</span><span class="s">&#39;dln_indprod&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">dta</span><span class="p">[</span><span class="s">&#39;dln_indprod&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">dta</span><span class="p">[</span><span class="s">&#39;std_income&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dta</span><span class="p">[</span><span class="s">&#39;dln_income&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dta</span><span class="p">[</span><span class="s">&#39;dln_income&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">dta</span><span class="p">[</span><span class="s">&#39;dln_income&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">dta</span><span class="p">[</span><span class="s">&#39;std_sales&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dta</span><span class="p">[</span><span class="s">&#39;dln_sales&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dta</span><span class="p">[</span><span class="s">&#39;dln_sales&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">dta</span><span class="p">[</span><span class="s">&#39;dln_sales&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">dta</span><span class="p">[</span><span class="s">&#39;std_emp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dta</span><span class="p">[</span><span class="s">&#39;dln_emp&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dta</span><span class="p">[</span><span class="s">&#39;dln_emp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">dta</span><span class="p">[</span><span class="s">&#39;dln_emp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="dynamic-factors">
<h2>Dynamic factors<a class="headerlink" href="#dynamic-factors" title="Permalink to this headline">Â¶</a></h2>
<p>A general dynamic factor model is written as:</p>
<div class="math">
\[\begin{split}\begin{align}
y_t &amp; = \Lambda f_t + B x_t + u_t \\
f_t &amp; = A_1 f_{t-1} + \dots + A_p f_{t-p} + \eta_t \qquad \eta_t \sim N(0, I)\\
u_t &amp; = C_1 u_{t-1} + \dots + C_1 f_{t-q} + \varepsilon_t \qquad \varepsilon_t \sim N(0, \Sigma)
\end{align}\end{split}\]</div>
<p>where <span class="math">\(y_t\)</span> are observed data, <span class="math">\(f_t\)</span> are the unobserved
factors (evolving as a vector autoregression), <span class="math">\(x_t\)</span> are
(optional) exogenous variables, and <span class="math">\(u_t\)</span> is the error, or
&#8220;idiosyncratic&#8221;, process (<span class="math">\(u_t\)</span> is also optionally allowed to be
autocorrelated). The <span class="math">\(\Lambda\)</span> matrix is often referred to as the
matrix of &#8220;factor loadings&#8221;. The variance of the factor error term is
set to the identity matrix to ensure identification of the unobserved
factors.</p>
<p>This model can be cast into state space form, and the unobserved factor
estimated via the Kalman filter. The likelihood can be evaluated as a
byproduct of the filtering recursions, and maximum likelihood estimation
used to estimate the parameters.</p>
</div>
<div class="section" id="model-specification">
<h2>Model specification<a class="headerlink" href="#model-specification" title="Permalink to this headline">Â¶</a></h2>
<p>The specific dynamic factor model in this application has 1 unobserved
factor which is assumed to follow an AR(2) proces. The innovations
<span class="math">\(\varepsilon_t\)</span> are assumed to be independent (so that
<span class="math">\(\Sigma\)</span> is a diagonal matrix) and the error term associated with
each equation, <span class="math">\(u_{i,t}\)</span> is assumed to follow an independent AR(2)
process.</p>
<p>Thus the specification considered here is:</p>
<div class="math">
\[\begin{split}\begin{align}
y_{i,t} &amp; = \lambda_i f_t + u_{i,t} \\
u_{i,t} &amp; = c_{i,1} u_{1,t-1} + c_{i,2} u_{i,t-2} + \varepsilon_{i,t} \qquad &amp; \varepsilon_{i,t} \sim N(0, \sigma_i^2) \\
f_t &amp; = a_1 f_{t-1} + a_2 f_{t-2} + \eta_t \qquad &amp; \eta_t \sim N(0, I)\\
\end{align}\end{split}\]</div>
<p>where <span class="math">\(i\)</span> is one of: <code class="docutils literal"><span class="pre">[indprod,</span> <span class="pre">income,</span> <span class="pre">sales,</span> <span class="pre">emp</span> <span class="pre">]</span></code>.</p>
<p>This model can be formulated using the built-in <code class="docutils literal"><span class="pre">DynamicFactor</span></code> model.
In particular, we have the following specification:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">k_factors</span> <span class="pre">=</span> <span class="pre">1</span></code> - (there is 1 unobserved factor)</li>
<li><code class="docutils literal"><span class="pre">factor_order</span> <span class="pre">=</span> <span class="pre">2</span></code> - (it follows an AR(2) process)</li>
<li><code class="docutils literal"><span class="pre">error_var</span> <span class="pre">=</span> <span class="pre">False</span></code> - (the errors evolve as independent AR
processes rather than jointly as a VAR - note that this is the
default option, so it is not specified below)</li>
<li><code class="docutils literal"><span class="pre">error_order</span> <span class="pre">=</span> <span class="pre">2</span></code> - (the errors are autocorrelated of order 2: i.e.
AR(2) processes)</li>
<li><code class="docutils literal"><span class="pre">error_cov_type</span> <span class="pre">=</span> <span class="pre">'diagonal'</span></code> - (the innovations are uncorrelated;
this is again the default)</li>
</ul>
<p>Once the model is created, the parameters can be estimated via maximum
likelihood; this is done using the <code class="docutils literal"><span class="pre">fit()</span></code> method.</p>
<p><strong>Note</strong>: recall that we have de-meaned and standardized the data; this
will be important in interpreting the results that follow.</p>
<p><strong>Aside</strong>: in their empirical example, Kim and Nelson (1999) actually
consider a slightly different model in which the employment variable is
allowed to also depend on lagged values of the factor - this model does
not fit into the built-in <code class="docutils literal"><span class="pre">DynamicFactor</span></code> class, but can be
accomodated by using a subclass to implement the required new parameters
and restrictions - see Appendix A, below.</p>
</div>
<div class="section" id="parameter-estimation">
<h2>Parameter estimation<a class="headerlink" href="#parameter-estimation" title="Permalink to this headline">Â¶</a></h2>
<p>Multivariate models can have a relatively large number of parameters,
and it may be difficult to escape from local minima to find the
maximized likelihood. In an attempt to mitigate this problem, I perform
an initial maximization step (from the model-defined starting paramters)
using the modified Powell method available in Scipy (see the minimize
documentation for more information). The resulting parameters are then
used as starting parameters in the standard LBFGS optimization method.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Get the endogenous data</span>
<span class="n">endog</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="s">&#39;1979-02-01&#39;</span><span class="p">:,</span> <span class="s">&#39;std_indprod&#39;</span><span class="p">:</span><span class="s">&#39;std_emp&#39;</span><span class="p">]</span>

<span class="c"># Create the model</span>
<span class="n">mod</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">ssm</span><span class="o">.</span><span class="n">DynamicFactor</span><span class="p">(</span><span class="n">endog</span><span class="p">,</span> <span class="n">k_factors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">factor_order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">error_order</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">initial_res</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s">&#39;powell&#39;</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">initial_res</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="estimates">
<h2>Estimates<a class="headerlink" href="#estimates" title="Permalink to this headline">Â¶</a></h2>
<p>Once the model has been estimated, there are two components that we can
use for analysis or inference:</p>
<ul class="simple">
<li>The estimated parameters</li>
<li>The estimated factor</li>
</ul>
<div class="section" id="parameters">
<h3>Parameters<a class="headerlink" href="#parameters" title="Permalink to this headline">Â¶</a></h3>
<p>The estimated parameters can be helpful in understanding the
implications of the model, although in models with a larger number of
observed variables and / or unobserved factors they can be difficult to
interpret.</p>
<p>One reason for this difficulty is due to identification issues between
the factor loadings and the unobserved factors. One easy-to-see
identification issue is the sign of the loadings and the factors: an
equivalent model to the one displayed below would result from reversing
the signs of all factor loadings and the unobserved factor.</p>
<p>Here, one of the easy-to-interpret implications in this model is the
persistence of the unobserved factor: we find that exhibits substantial
persistence.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">separate_params</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>                                             Statespace Model Results
=================================================================================================================
Dep. Variable:     [&#39;std_indprod&#39;, &#39;std_income&#39;, &#39;std_sales&#39;, &#39;std_emp&#39;]   No. Observations:                  431
Model:                                 DynamicFactor(factors=1, order=2)   Log Likelihood               -2031.923
                                                          + AR(2) errors   AIC                           4099.847
Date:                                                   Mon, 21 Sep 2015   BIC                           4173.037
Time:                                                           14:49:23   HQIC                          4128.745
Sample:                                                       02-01-1979
                                                            - 12-01-2014
Covariance Type:                                                     opg
====================================================================================================
                                       coef    std err          z      P&gt;|z|      [0.025      0.975]
----------------------------------------------------------------------------------------------------
loading.f1.std_indprod              -0.6200      0.044    -14.008      0.000      -0.707      -0.533
loading.f1.std_income               -0.2433      0.034     -7.179      0.000      -0.310      -0.177
loading.f1.std_sales                -0.3903      0.028    -13.888      0.000      -0.445      -0.335
loading.f1.std_emp                  -0.4242      0.043     -9.916      0.000      -0.508      -0.340
sigma2.std_indprod                   0.2713      0.034      8.061      0.000       0.205       0.337
sigma2.std_income                    0.8556      0.025     34.327      0.000       0.807       0.904
sigma2.std_sales                     0.5453      0.043     12.821      0.000       0.462       0.629
sigma2.std_emp                       0.2664      0.025     10.546      0.000       0.217       0.316
L1.f1.f1                             0.4766      0.098      4.849      0.000       0.284       0.669
L2.f1.f1                             0.2400      0.086      2.780      0.005       0.071       0.409
L1.e(std_indprod).e(std_indprod)    -0.4383      0.099     -4.424      0.000      -0.632      -0.244
L2.e(std_indprod).e(std_indprod)    -0.1831      0.064     -2.840      0.005      -0.309      -0.057
L1.e(std_income).e(std_income)      -0.2133      0.023     -9.081      0.000      -0.259      -0.167
L2.e(std_income).e(std_income)      -0.1019      0.041     -2.479      0.013      -0.183      -0.021
L1.e(std_sales).e(std_sales)        -0.6198      0.051    -12.058      0.000      -0.721      -0.519
L2.e(std_sales).e(std_sales)        -0.2864      0.052     -5.523      0.000      -0.388      -0.185
L1.e(std_emp).e(std_emp)             0.2828      0.042      6.745      0.000       0.201       0.365
L2.e(std_emp).e(std_emp)             0.4988      0.048     10.447      0.000       0.405       0.592
=======================================================================================================
Ljung-Box (Q):          38.19, 24.28, 63.01, 60.10   Jarque-Bera (JB):   80.22, 17685.91, 7.60, 4196.02
Prob(Q):                    0.55, 0.98, 0.01, 0.02   Prob(JB):                   0.00, 0.00, 0.02, 0.00
Heteroskedasticity (H):     0.74, 4.60, 0.71, 0.32   Skew:                      0.54, -1.56, 0.13, 1.03
Prob(H) (two-sided):        0.07, 0.00, 0.04, 0.00   Kurtosis:                 4.82, 34.23, 3.60, 18.15
=======================================================================================================

Warnings:
[1] Covariance matrix calculated using the outer product of gradients.
</pre></div>
</div>
</div>
<div class="section" id="estimated-factors">
<h3>Estimated factors<a class="headerlink" href="#estimated-factors" title="Permalink to this headline">Â¶</a></h3>
<p>While it can be useful to plot the unobserved factors, it is less useful
here than one might think for two reasons:</p>
<ol class="arabic simple">
<li>The sign-related identification issue described above.</li>
<li>Since the data was differenced, the estimated factor explains the
variation in the differenced data, not the original data.</li>
</ol>
<p>It is for these reasons that the coincident index is created (see
below).</p>
<p>With these reservations, the unobserved factor is plotted below, along
with the NBER indicators for US recessions. It appears that the factor
is successful at picking up some degree of business cycle activity.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

<span class="c"># Plot the factor</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">endog</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">_mpl_repr</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">factors</span><span class="o">.</span><span class="n">filtered</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;Factor&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c"># Retrieve and also plot the NBER recession indicators</span>
<span class="n">rec</span> <span class="o">=</span> <span class="n">DataReader</span><span class="p">(</span><span class="s">&#39;USREC&#39;</span><span class="p">,</span> <span class="s">&#39;fred&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
<span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">dates</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rec</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../../_images/dfm_coincident.ipynb_19_0.png" src="../../_images/dfm_coincident.ipynb_19_0.png" />
</div>
</div>
<div class="section" id="post-estimation">
<h2>Post-estimation<a class="headerlink" href="#post-estimation" title="Permalink to this headline">Â¶</a></h2>
<p>Although here we will be able to interpret the results of the model by
constructing the coincident index, there is a useful and generic
approach for getting a sense for what is being captured by the estimated
factor. By taking the estimated factors as given, regressing them (and a
constant) each (one at a time) on each of the observed variables, and
recording the coefficients of determination (<span class="math">\(R^2\)</span> values), we can
get a sense of the variables for which each factor explains a
substantial portion of the variance and the variables for which it does
not.</p>
<p>In models with more variables and more factors, this can sometimes lend
interpretation to the factors (for example sometimes one factor will
load primarily on real variables and another on nominal variables).</p>
<p>In this model, with only four endogenous variables and one factor, it is
easy to digest a simple table of the <span class="math">\(R^2\)</span> values, but in larger
models it is not. For this reason, a bar plot is often employed; from
the plot we can easily see that the factor explains most of the
variation in industrial production index and a large portion of the
variation in sales and employment, it is less helpful in explaining
income.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">res</span><span class="o">.</span><span class="n">plot_coefficients_of_determination</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
</pre></div>
</div>
<img alt="../../_images/dfm_coincident.ipynb_21_0.png" src="../../_images/dfm_coincident.ipynb_21_0.png" />
</div>
<div class="section" id="coincident-index">
<h2>Coincident Index<a class="headerlink" href="#coincident-index" title="Permalink to this headline">Â¶</a></h2>
<p>As described above, the goal of this model was to create an
interpretable series which could be used to understand the current
status of the macroeconomy. This is what the coincident index is
designed to do. It is constructed below. For readers interested in an
explanation of the construction, see Kim and Nelson (1999) or Stock and
Watson (1991).</p>
<p>In essense, what is done is to reconstruct the mean of the (differenced)
factor. We will compare it to the coincident index on published by the
Federal Reserve Bank of Philadelphia (USPHCI on FRED).</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">usphci</span> <span class="o">=</span> <span class="n">DataReader</span><span class="p">(</span><span class="s">&#39;USPHCI&#39;</span><span class="p">,</span> <span class="s">&#39;fred&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s">&#39;1979-01-01&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;2014-12-01&#39;</span><span class="p">)[</span><span class="s">&#39;USPHCI&#39;</span><span class="p">]</span>
<span class="n">usphci</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span>
</pre></div>
</div>
<img alt="../../_images/dfm_coincident.ipynb_23_0.png" src="../../_images/dfm_coincident.ipynb_23_0.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">dusphci</span> <span class="o">=</span> <span class="n">usphci</span><span class="o">.</span><span class="n">diff</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>
<span class="k">def</span> <span class="nf">compute_coincident_index</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
    <span class="c"># Estimate W(1)</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">specification</span>
    <span class="n">design</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">ssm</span><span class="p">[</span><span class="s">&#39;design&#39;</span><span class="p">]</span>
    <span class="n">transition</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">ssm</span><span class="p">[</span><span class="s">&#39;transition&#39;</span><span class="p">]</span>
    <span class="n">ss_kalman_gain</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">filter_results</span><span class="o">.</span><span class="n">kalman_gain</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">k_states</span> <span class="o">=</span> <span class="n">ss_kalman_gain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">W1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">k_states</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">k_states</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ss_kalman_gain</span><span class="p">,</span> <span class="n">design</span><span class="p">),</span>
        <span class="n">transition</span>
    <span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ss_kalman_gain</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c"># Compute the factor mean vector</span>
    <span class="n">factor_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W1</span><span class="p">,</span> <span class="n">dta</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="s">&#39;1972-02-01&#39;</span><span class="p">:,</span> <span class="s">&#39;dln_indprod&#39;</span><span class="p">:</span><span class="s">&#39;dln_emp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

    <span class="c"># Normalize the factors</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">factors</span><span class="o">.</span><span class="n">filtered</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">factor</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">usphci</span><span class="o">.</span><span class="n">diff</span><span class="p">()[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span>

    <span class="c"># Compute the coincident index</span>
    <span class="n">coincident_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">nobs</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="c"># The initial value is arbitrary; here it is set to</span>
    <span class="c"># facilitate comparison</span>
    <span class="n">coincident_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">usphci</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">factor_mean</span> <span class="o">/</span> <span class="n">dusphci</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mod</span><span class="o">.</span><span class="n">nobs</span><span class="p">):</span>
        <span class="n">coincident_index</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">coincident_index</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">factor</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">factor_mean</span>

    <span class="c"># Attach dates</span>
    <span class="n">coincident_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">TimeSeries</span><span class="p">(</span><span class="n">coincident_index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">dta</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c"># Normalize to use the same base year as USPHCI</span>
    <span class="n">coincident_index</span> <span class="o">*=</span> <span class="p">(</span><span class="n">usphci</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="s">&#39;1992-07-01&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">coincident_index</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="s">&#39;1992-07-01&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">coincident_index</span>
</pre></div>
</div>
<p>Below we plot the calculated coincident index along with the US
recessions and the comparison coincident index USPHCI.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

<span class="c"># Compute the index</span>
<span class="n">coincident_index</span> <span class="o">=</span> <span class="n">compute_coincident_index</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

<span class="c"># Plot the factor</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">endog</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">_mpl_repr</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">coincident_index</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;Coincident index&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">usphci</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">_mpl_repr</span><span class="p">(),</span> <span class="n">usphci</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;USPHCI&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;lower right&#39;</span><span class="p">)</span>

<span class="c"># Retrieve and also plot the NBER recession indicators</span>
<span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">dates</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rec</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../../_images/dfm_coincident.ipynb_26_0.png" src="../../_images/dfm_coincident.ipynb_26_0.png" />
</div>
<div class="section" id="appendix-1-extending-the-dynamic-factor-model">
<h2>Appendix 1: Extending the dynamic factor model<a class="headerlink" href="#appendix-1-extending-the-dynamic-factor-model" title="Permalink to this headline">Â¶</a></h2>
<p>Recall that the previous specification was described by:</p>
<div class="math">
\[\begin{split}\begin{align}
y_{i,t} &amp; = \lambda_i f_t + u_{i,t} \\
u_{i,t} &amp; = c_{i,1} u_{1,t-1} + c_{i,2} u_{i,t-2} + \varepsilon_{i,t} \qquad &amp; \varepsilon_{i,t} \sim N(0, \sigma_i^2) \\
f_t &amp; = a_1 f_{t-1} + a_2 f_{t-2} + \eta_t \qquad &amp; \eta_t \sim N(0, I)\\
\end{align}\end{split}\]</div>
<p>Written in state space form, the previous specification of the model had
the following observation equation:</p>
<div class="math">
\[\begin{split}\begin{bmatrix}
y_{\text{indprod}, t} \\
y_{\text{income}, t} \\
y_{\text{sales}, t} \\
y_{\text{emp}, t} \\
\end{bmatrix} = \begin{bmatrix}
\lambda_\text{indprod} &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\lambda_\text{income}  &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\lambda_\text{sales}   &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\lambda_\text{emp}     &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\end{bmatrix}
\begin{bmatrix}
f_t \\
f_{t-1} \\
u_{\text{indprod}, t} \\
u_{\text{income}, t} \\
u_{\text{sales}, t} \\
u_{\text{emp}, t} \\
u_{\text{indprod}, t-1} \\
u_{\text{income}, t-1} \\
u_{\text{sales}, t-1} \\
u_{\text{emp}, t-1} \\
\end{bmatrix}\end{split}\]</div>
<p>and transition equation:</p>
<div class="math">
\[\begin{split}\begin{bmatrix}
f_t \\
f_{t-1} \\
u_{\text{indprod}, t} \\
u_{\text{income}, t} \\
u_{\text{sales}, t} \\
u_{\text{emp}, t} \\
u_{\text{indprod}, t-1} \\
u_{\text{income}, t-1} \\
u_{\text{sales}, t-1} \\
u_{\text{emp}, t-1} \\
\end{bmatrix} = \begin{bmatrix}
a_1 &amp; a_2 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
1   &amp; 0   &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
0   &amp; 0   &amp; c_{\text{indprod}, 1} &amp; 0 &amp; 0 &amp; 0 &amp; c_{\text{indprod}, 2} &amp; 0 &amp; 0 &amp; 0 \\
0   &amp; 0   &amp; 0 &amp; c_{\text{income}, 1} &amp; 0 &amp; 0 &amp; 0 &amp; c_{\text{income}, 2} &amp; 0 &amp; 0 \\
0   &amp; 0   &amp; 0 &amp; 0 &amp; c_{\text{sales}, 1} &amp; 0 &amp; 0 &amp; 0 &amp; c_{\text{sales}, 2} &amp; 0 \\
0   &amp; 0   &amp; 0 &amp; 0 &amp; 0 &amp; c_{\text{emp}, 1} &amp; 0 &amp; 0 &amp; 0 &amp; c_{\text{emp}, 2} \\
0   &amp; 0   &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
0   &amp; 0   &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
0   &amp; 0   &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
0   &amp; 0   &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\end{bmatrix}
\begin{bmatrix}
f_{t-1} \\
f_{t-2} \\
u_{\text{indprod}, t-1} \\
u_{\text{income}, t-1} \\
u_{\text{sales}, t-1} \\
u_{\text{emp}, t-1} \\
u_{\text{indprod}, t-2} \\
u_{\text{income}, t-2} \\
u_{\text{sales}, t-2} \\
u_{\text{emp}, t-2} \\
\end{bmatrix}
+ R \begin{bmatrix}
\eta_t \\
\varepsilon_{t}
\end{bmatrix}\end{split}\]</div>
<p>the <code class="docutils literal"><span class="pre">DynamicFactor</span></code> model handles setting up the state space
representation and, in the <code class="docutils literal"><span class="pre">DynamicFactor.update</span></code> method, it fills in
the fitted parameter values into the appropriate locations.</p>
<p>The extended specification is the same as in the previous example,
except that we also want to allow employment to depend on lagged values
of the factor. This creates a change to the <span class="math">\(y_{\text{emp},t}\)</span>
equation. Now we have:</p>
<div class="math">
\[\begin{split}\begin{align}
y_{i,t} &amp; = \lambda_i f_t + u_{i,t} \qquad &amp; i \in \{\text{indprod}, \text{income}, \text{sales} \}\\
y_{i,t} &amp; = \lambda_{i,0} f_t + \lambda_{i,1} f_{t-1} + \lambda_{i,2} f_{t-2} + \lambda_{i,2} f_{t-3} + u_{i,t} \qquad &amp; i = \text{emp} \\
u_{i,t} &amp; = c_{i,1} u_{i,t-1} + c_{i,2} u_{i,t-2} + \varepsilon_{i,t} \qquad &amp; \varepsilon_{i,t} \sim N(0, \sigma_i^2) \\
f_t &amp; = a_1 f_{t-1} + a_2 f_{t-2} + \eta_t \qquad &amp; \eta_t \sim N(0, I)\\
\end{align}\end{split}\]</div>
<p>Now, the corresponding observation equation should look like the
following:</p>
<div class="math">
\[\begin{split}\begin{bmatrix}
y_{\text{indprod}, t} \\
y_{\text{income}, t} \\
y_{\text{sales}, t} \\
y_{\text{emp}, t} \\
\end{bmatrix} = \begin{bmatrix}
\lambda_\text{indprod} &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\lambda_\text{income}  &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\lambda_\text{sales}   &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\lambda_\text{emp,1}   &amp; \lambda_\text{emp,2} &amp; \lambda_\text{emp,3} &amp; \lambda_\text{emp,4} &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\end{bmatrix}
\begin{bmatrix}
f_t \\
f_{t-1} \\
f_{t-2} \\
f_{t-3} \\
u_{\text{indprod}, t} \\
u_{\text{income}, t} \\
u_{\text{sales}, t} \\
u_{\text{emp}, t} \\
u_{\text{indprod}, t-1} \\
u_{\text{income}, t-1} \\
u_{\text{sales}, t-1} \\
u_{\text{emp}, t-1} \\
\end{bmatrix}\end{split}\]</div>
<p>Notice that we have introduced two new state variables, <span class="math">\(f_{t-2}\)</span>
and <span class="math">\(f_{t-3}\)</span>, which means we need to update the transition
equation:</p>
<div class="math">
\[\begin{split}\begin{bmatrix}
f_t \\
f_{t-1} \\
f_{t-2} \\
f_{t-3} \\
u_{\text{indprod}, t} \\
u_{\text{income}, t} \\
u_{\text{sales}, t} \\
u_{\text{emp}, t} \\
u_{\text{indprod}, t-1} \\
u_{\text{income}, t-1} \\
u_{\text{sales}, t-1} \\
u_{\text{emp}, t-1} \\
\end{bmatrix} = \begin{bmatrix}
a_1 &amp; a_2 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
1   &amp; 0   &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
0   &amp; 1   &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
0   &amp; 0   &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
0   &amp; 0   &amp; 0 &amp; 0 &amp; c_{\text{indprod}, 1} &amp; 0 &amp; 0 &amp; 0 &amp; c_{\text{indprod}, 2} &amp; 0 &amp; 0 &amp; 0 \\
0   &amp; 0   &amp; 0 &amp; 0 &amp; 0 &amp; c_{\text{income}, 1} &amp; 0 &amp; 0 &amp; 0 &amp; c_{\text{income}, 2} &amp; 0 &amp; 0 \\
0   &amp; 0   &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; c_{\text{sales}, 1} &amp; 0 &amp; 0 &amp; 0 &amp; c_{\text{sales}, 2} &amp; 0 \\
0   &amp; 0   &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; c_{\text{emp}, 1} &amp; 0 &amp; 0 &amp; 0 &amp; c_{\text{emp}, 2} \\
0   &amp; 0   &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
0   &amp; 0   &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
0   &amp; 0   &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
0   &amp; 0   &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\end{bmatrix}
\begin{bmatrix}
f_{t-1} \\
f_{t-2} \\
f_{t-3} \\
f_{t-4} \\
u_{\text{indprod}, t-1} \\
u_{\text{income}, t-1} \\
u_{\text{sales}, t-1} \\
u_{\text{emp}, t-1} \\
u_{\text{indprod}, t-2} \\
u_{\text{income}, t-2} \\
u_{\text{sales}, t-2} \\
u_{\text{emp}, t-2} \\
\end{bmatrix}
+ R \begin{bmatrix}
\eta_t \\
\varepsilon_{t}
\end{bmatrix}\end{split}\]</div>
<p>This model cannot be handled out-of-the-box by the <code class="docutils literal"><span class="pre">DynamicFactor</span></code>
class, but it can be handled by creating a subclass when alters the
state space representation in the appropriate way.</p>
<p>First, notice that if we had set <code class="docutils literal"><span class="pre">factor_order</span> <span class="pre">=</span> <span class="pre">4</span></code>, we would almost
have what we wanted. In that case, the last line of the observation
equation would be:</p>
<div class="math">
\[\begin{split}\begin{bmatrix}
\vdots \\
y_{\text{emp}, t} \\
\end{bmatrix} = \begin{bmatrix}
\vdots &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp; \vdots \\
\lambda_\text{emp,1}   &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\end{bmatrix}
\begin{bmatrix}
f_t \\
f_{t-1} \\
f_{t-2} \\
f_{t-3} \\
\vdots
\end{bmatrix}\end{split}\]</div>
<p>and the first line of the transition equation would be:</p>
<div class="math">
\[\begin{split}\begin{bmatrix}
f_t \\
\vdots
\end{bmatrix} = \begin{bmatrix}
a_1 &amp; a_2 &amp; a_3 &amp; a_4 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\vdots &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp; \vdots \\
\end{bmatrix}
\begin{bmatrix}
f_{t-1} \\
f_{t-2} \\
f_{t-3} \\
f_{t-4} \\
\vdots
\end{bmatrix}
+ R \begin{bmatrix}
\eta_t \\
\varepsilon_{t}
\end{bmatrix}\end{split}\]</div>
<p>Relative to what we want, we have the following differences:</p>
<ol class="arabic simple">
<li>In the above situation, the <span class="math">\(\lambda_{\text{emp}, j}\)</span> are
forced to be zero for <span class="math">\(j &gt; 0\)</span>, and we want them to be estimated
as parameters.</li>
<li>We only want the factor to transition according to an AR(2), but
under the above situation it is an AR(4).</li>
</ol>
<p>Our strategy will be to subclass <code class="docutils literal"><span class="pre">DynamicFactor</span></code>, and let it do most
of the work (setting up the state space representation, etc.) where it
assumes that <code class="docutils literal"><span class="pre">factor_order</span> <span class="pre">=</span> <span class="pre">4</span></code>. The only things we will actually do
in the subclass will be to fix those two issues.</p>
<p>First, here is the full code of the subclass; it is discussed below. It
is important to note at the outset that none of the methods defined
below could have been omitted. In fact, the methods <code class="docutils literal"><span class="pre">__init__</span></code>,
<code class="docutils literal"><span class="pre">start_params</span></code>, <code class="docutils literal"><span class="pre">param_names</span></code>, <code class="docutils literal"><span class="pre">transform_params</span></code>,
<code class="docutils literal"><span class="pre">untransform_params</span></code>, and <code class="docutils literal"><span class="pre">update</span></code> form the core of all state space
models, not just the <code class="docutils literal"><span class="pre">DynamicFactor</span></code> class.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">dismalpy.ssm</span> <span class="kn">import</span> <span class="n">tools</span>
<span class="k">class</span> <span class="nc">ExtendedDFM</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">ssm</span><span class="o">.</span><span class="n">DynamicFactor</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endog</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c"># Setup the model as if we had a factor order of 4</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">ExtendedDFM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                <span class="n">endog</span><span class="p">,</span> <span class="n">k_factors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">factor_order</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">error_order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c"># Note: `self.parameters` is an ordered dict with the</span>
            <span class="c"># keys corresponding to parameter types, and the values</span>
            <span class="c"># the number of parameters of that type.</span>
            <span class="c"># Reset the number of AR parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s">&#39;factor_transition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="c"># Add the new parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s">&#39;new_loadings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>

            <span class="c"># Cache a slice for the location of the 4 factor AR</span>
            <span class="c"># parameters (a_1, ..., a_4) in the full parameter vector</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ar_offset</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s">&#39;factor_loadings&#39;</span><span class="p">]</span> <span class="o">+</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s">&#39;exog&#39;</span><span class="p">]</span> <span class="o">+</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s">&#39;error_cov&#39;</span><span class="p">])</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ar_offset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_params_factor_ar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_params_factor_zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">start_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Remove the two autoregressive terms we don&#39;t need</span>
        <span class="c"># Add three new loading parameters to the end of the parameter</span>
        <span class="c"># vector, initialized to zeros (for simplicity; they could</span>
        <span class="c"># be initialized any way you like)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ExtendedDFM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">start_params</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ar_offset</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">params</span><span class="p">[:</span><span class="n">offset</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">4</span><span class="p">:],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">param_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Add the corresponding names for the new loading parameters</span>
        <span class="c">#  (the name can be anything you like)</span>
        <span class="n">param_names</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ExtendedDFM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">param_names</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ar_offset</span>
        <span class="k">return</span> <span class="n">param_names</span><span class="p">[:</span><span class="n">offset</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">param_names</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">4</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="s">&#39;loading.L</span><span class="si">%d</span><span class="s">.f1.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog_names</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">transform_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unconstrained</span><span class="p">):</span>
        <span class="c"># Perform the typical DFM transformation (w/o the new parameters)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ar_offset</span>
        <span class="n">constrained</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ExtendedDFM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">transform_params</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">unconstrained</span><span class="p">[:</span><span class="n">offset</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">unconstrained</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">]])</span>

        <span class="c"># Redo the factor AR constraint, since we only want an AR(2),</span>
        <span class="c"># and the previous constraint was for an AR(4)</span>
        <span class="n">ar_params</span> <span class="o">=</span> <span class="n">unconstrained</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_params_factor_ar</span><span class="p">]</span>
        <span class="n">constrained</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_params_factor_ar</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">tools</span><span class="o">.</span><span class="n">constrain_stationary_univariate</span><span class="p">(</span><span class="n">ar_params</span><span class="p">))</span>

        <span class="c"># Return all the parameters</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">constrained</span><span class="p">[:</span><span class="n">offset</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="n">constrained</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">4</span><span class="p">:],</span> <span class="n">unconstrained</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]]</span>

    <span class="k">def</span> <span class="nf">untransform_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constrained</span><span class="p">):</span>
        <span class="c"># Perform the typical DFM untransformation (w/o the new parameters)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ar_offset</span>
        <span class="n">unconstrained</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ExtendedDFM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">untransform_params</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">constrained</span><span class="p">[:</span><span class="n">offset</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">constrained</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">]])</span>

        <span class="c"># Redo the factor AR unconstraint, since we only want an AR(2),</span>
        <span class="c"># and the previous unconstraint was for an AR(4)</span>
        <span class="n">ar_params</span> <span class="o">=</span> <span class="n">constrained</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_params_factor_ar</span><span class="p">]</span>
        <span class="n">unconstrained</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_params_factor_ar</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">tools</span><span class="o">.</span><span class="n">unconstrain_stationary_univariate</span><span class="p">(</span><span class="n">ar_params</span><span class="p">))</span>

        <span class="c"># Return all the parameters</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">unconstrained</span><span class="p">[:</span><span class="n">offset</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="n">unconstrained</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">4</span><span class="p">:],</span> <span class="n">constrained</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]]</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">transformed</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="c"># Peform the transformation, if required</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">transformed</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="c"># Now perform the usual DFM update, but exclude our new parameters</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ar_offset</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ExtendedDFM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">params</span><span class="p">[:</span><span class="n">offset</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">]],</span> <span class="n">transformed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># Finally, set our new parameters in the design matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssm</span><span class="p">[</span><span class="s">&#39;design&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
</pre></div>
</div>
<p>So what did we just do?</p>
<p><strong>``__init__``</strong></p>
<p>The important step here was specifying the base dynamic factor model
which we were operating with. In particular, as described above, we
initialize with <code class="docutils literal"><span class="pre">factor_order=4</span></code>, even though we will only end up with
an AR(2) model for the factor. We also performed some general
setup-related tasks.</p>
<p><strong>``start_params``</strong></p>
<p><code class="docutils literal"><span class="pre">start_params</span></code> are used as initial values in the optimizer. Since we
are adding three new parameters, we need to pass those in. If we hadn&#8217;t
done this, the optimizer would use the default starting values, which
would be three elements short.</p>
<p><strong>``param_names``</strong></p>
<p><code class="docutils literal"><span class="pre">param_names</span></code> are used in a variety of places, but especially in the
results class. Below we get a full result summary, which is only
possible when all the parameters have associated names.</p>
<p><strong>``transform_params`` and ``untransform_params``</strong></p>
<p>The optimizer selects possibly parameter values in an unconstrained way.
That&#8217;s not usually desired (since variances can&#8217;t be negative, for
example), and <code class="docutils literal"><span class="pre">transform_params</span></code> is used to transform the
unconstrained values used by the optimizer to constrained values
appropriate to the model. Variances terms are typically squared (to
force them to be positive), and AR lag coefficients are often
constrained to lead to a stationary model. <code class="docutils literal"><span class="pre">untransform_params</span></code> is
used for the reverse operation (and is important because starting
parameters are usually specified in terms of values appropriate to the
model, and we need to convert them to parameters appropriate to the
optimizer before we can begin the optimization routine).</p>
<p>Even though we don&#8217;t need to transform or untransform our new parameters
(the loadings can in theory take on any values), we still need to modify
this function for two reasons:</p>
<ol class="arabic simple">
<li>The version in the <code class="docutils literal"><span class="pre">DynamicFactor</span></code> class is expecting 3 fewer
parameters than we have now. At a minimum, we need to handle the
three new parameters.</li>
<li>The version in the <code class="docutils literal"><span class="pre">DynamicFactor</span></code> class constrains the factor lag
coefficients to be stationary as though it was an AR(4) model. Since
we actually have an AR(2) model, we need to re-do the constraint. We
also set the last two autoregressive coefficients to be zero here.</li>
</ol>
<p><strong>``update``</strong></p>
<p>The most important reason we need to specify a new <code class="docutils literal"><span class="pre">update</span></code> method is
because we have three new parameters that we need to place into the
state space formulation. In particular we let the parent
<code class="docutils literal"><span class="pre">DynamicFactor.update</span></code> class handle placing all the parameters except
the three new ones in to the state space representation, and then we put
the last three in manually.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Create the model</span>
<span class="n">extended_mod</span> <span class="o">=</span> <span class="n">ExtendedDFM</span><span class="p">(</span><span class="n">endog</span><span class="p">)</span>
<span class="n">initial_extended_res</span> <span class="o">=</span> <span class="n">extended_mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s">&#39;powell&#39;</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">extended_res</span> <span class="o">=</span> <span class="n">extended_mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">initial_extended_res</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">extended_res</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">separate_params</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>                                             Statespace Model Results
=================================================================================================================
Dep. Variable:     [&#39;std_indprod&#39;, &#39;std_income&#39;, &#39;std_sales&#39;, &#39;std_emp&#39;]   No. Observations:                  431
Model:                                 DynamicFactor(factors=1, order=4)   Log Likelihood               -2017.789
                                                          + AR(2) errors   AIC                           4077.578
Date:                                                   Mon, 21 Sep 2015   BIC                           4162.966
Time:                                                           14:49:35   HQIC                          4111.292
Sample:                                                       02-01-1979
                                                            - 12-01-2014
Covariance Type:                                                     opg
====================================================================================================
                                       coef    std err          z      P&gt;|z|      [0.025      0.975]
----------------------------------------------------------------------------------------------------
loading.f1.std_indprod              -0.5982      0.049    -12.310      0.000      -0.693      -0.503
loading.f1.std_income               -0.2333      0.035     -6.739      0.000      -0.301      -0.165
loading.f1.std_sales                -0.3789      0.031    -12.058      0.000      -0.440      -0.317
loading.f1.std_emp                  -0.4397      0.040    -11.128      0.000      -0.517      -0.362
sigma2.std_indprod                   0.2730      0.035      7.809      0.000       0.204       0.341
sigma2.std_income                    0.8587      0.026     32.474      0.000       0.807       0.911
sigma2.std_sales                     0.5352      0.041     12.943      0.000       0.454       0.616
sigma2.std_emp                       0.2389      0.024      9.800      0.000       0.191       0.287
L1.f1.f1                             0.5496      0.114      4.803      0.000       0.325       0.774
L2.f1.f1                             0.1724      0.101      1.716      0.086      -0.025       0.369
L1.e(std_indprod).e(std_indprod)    -0.4774      0.098     -4.876      0.000      -0.669      -0.286
L2.e(std_indprod).e(std_indprod)    -0.2057      0.067     -3.066      0.002      -0.337      -0.074
L1.e(std_income).e(std_income)      -0.2162      0.024     -8.960      0.000      -0.263      -0.169
L2.e(std_income).e(std_income)      -0.1033      0.044     -2.334      0.020      -0.190      -0.017
L1.e(std_sales).e(std_sales)        -0.6260      0.052    -12.078      0.000      -0.728      -0.524
L2.e(std_sales).e(std_sales)        -0.2861      0.051     -5.566      0.000      -0.387      -0.185
L1.e(std_emp).e(std_emp)             0.2646      0.055      4.828      0.000       0.157       0.372
L2.e(std_emp).e(std_emp)             0.4711      0.059      7.993      0.000       0.356       0.587
loading.L1.f1.std_emp                0.0589      0.057      1.039      0.299      -0.052       0.170
loading.L2.f1.std_emp               -0.0592      0.053     -1.126      0.260      -0.162       0.044
loading.L3.f1.std_emp               -0.1394      0.033     -4.256      0.000      -0.204      -0.075
=======================================================================================================
Ljung-Box (Q):          37.21, 24.38, 63.34, 56.41   Jarque-Bera (JB):   57.28, 17715.76, 6.87, 3842.76
Prob(Q):                    0.60, 0.98, 0.01, 0.04   Prob(JB):                   0.00, 0.00, 0.03, 0.00
Heteroskedasticity (H):     0.79, 4.66, 0.73, 0.30   Skew:                      0.47, -1.54, 0.11, 1.05
Prob(H) (two-sided):        0.16, 0.00, 0.06, 0.00   Kurtosis:                 4.52, 34.26, 3.58, 17.48
=======================================================================================================

Warnings:
[1] Covariance matrix calculated using the outer product of gradients.
</pre></div>
</div>
<p>Although this model increases the likelihood, it is not preferred by the
AIC and BIC mesaures which penalize the additional three parameters.</p>
<p>Furthermore, the qualitative results are unchanged, as we can see from
the updated <span class="math">\(R^2\)</span> chart and the new coincident index, both of
which are practically identical to the previous results.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">extended_res</span><span class="o">.</span><span class="n">plot_coefficients_of_determination</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
</pre></div>
</div>
<img alt="../../_images/dfm_coincident.ipynb_34_0.png" src="../../_images/dfm_coincident.ipynb_34_0.png" />
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

<span class="c"># Compute the index</span>
<span class="n">extended_coincident_index</span> <span class="o">=</span> <span class="n">compute_coincident_index</span><span class="p">(</span><span class="n">extended_mod</span><span class="p">,</span> <span class="n">extended_res</span><span class="p">)</span>

<span class="c"># Plot the factor</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">endog</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">_mpl_repr</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">coincident_index</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;Basic model&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">extended_coincident_index</span><span class="p">,</span> <span class="s">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;Extended model&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">usphci</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">_mpl_repr</span><span class="p">(),</span> <span class="n">usphci</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;USPHCI&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;lower right&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Coincident indices, comparison&#39;</span><span class="p">)</span>

<span class="c"># Retrieve and also plot the NBER recession indicators</span>
<span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">dates</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rec</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../../_images/dfm_coincident.ipynb_35_0.png" src="../../_images/dfm_coincident.ipynb_35_0.png" />
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="varmax.ipynb.html" class="btn btn-neutral float-right" title="VARMAX models" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="structural_harvey_jaeger.ipynb.html" class="btn btn-neutral" title="Detrending, Stylized Facts and the Business Cycle" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Chad Fulton.
    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>